/*
                                                                                                                                                             
                                                                                                                                                              
                                                                                                                                                              
                                                                                                                                                              
                                                             ```                                                                                              
                                                            .,::.                                                                                             
                                                           `::;;:.                                             ``,::.`                                        
                                                           .;;;';,                        ``                ``.,;'''';.                                       
                                                           .;;;;;:`                 ``.,::,:,,..`          `.:;''''''':`                                      
                                                           `:;;;;:,               .,:;;;:::::::::,.`     ``:;''';;'''';`                                      
                                                           `:;;;;;:`            .:;;:;;;;;::;;::::::.```.:''+'''++++'+'`                                      
                                                            ,;;''';:          `,;;;;;;'';;;;;;;;::;::::';''''''+'+''+'',                                      
                                                            `:;';'';`        `,;;;;;;'''';;;;::;:;:;;;''''''''''';:'+++,`                                     
                                                            `:;'''+;,       `:;;;'''';;;';;'';;::;;;'''''''''';,.``,+++;`                                     
                                                             .;''++';`      ,;;++''+;;'''''''''::;;';'++''';:,``   .+++;`                                     
                                                             .:''+''''     .;'++'''''';'''+'''';;''''+++'';.`       '++'.`                                    
                                                             `:''++'+'    `;''++'''''''''+''''+:;'+''+'''',`        ;++',`                                    
                                                             `;++++++'    ,'''++'++'++++'+++++';++'''+';;':         :+'',`                                    
                                                             `:'++++'+:  `;''+++++'++++++++++++'''+'''+'';;`        .'+':`                                    
                                                              ,;++++++'  ,'''++++#'+'+++++##+++++#+++++';';.       `,''';.``` `                               
                                                              .;'+++++'  ;''++++##+#+#+####'#+++#+###++''';,   `.'';'''''';:,::,,.`                           
                                                              `:'++++++ `'''+++++####+#+##+++##+#+##+++''''; ,;'+'''++''+'+++''+''':`                         
                                                 `..`         `.:'+++#+``'''+++#+######+##'++##'######'';'':'++++'++++++++++'+'''';;:`                        
                                             `.:;';;'';::      `,'+#+#+,.''+++##+###########++###+###+';;;'+++#++++++''''+++++++++''':`                       
                                          ``.:'''+'''+'';'``    `'++##+'.''+++###############+#######+';;'+++++++++++++''+++++++++++;;,                       
                                        `.,;';''+++++'''''+.    `:++###+:'+++##############+#########+'';'####++;;::'+';''+'+''''+++'+'.                      
                                     `.:;'''+'+++'+++''++''+`    ,++####''+++#+#############++#######+'''####+#+;..```.'+'+'';;,:'+'++':`                     
                                    `,;''''++'+++++'''+#+'+''`   `'++###+'+++#################+######++'+#+####+;,.`   .;'+':;;,`,.'++''.`                    
                                   `;;''++++++'++;'::'###++++;`   ;++####'++++####+#################+#'+#####+++:.``    `,+'';';. `.'++';`                    
                                  `;'+'++++++':::....,+++#++#+.   .+#####'+++#########################++###+++++,..`      `:''';` ``'+++',`                   
                                 `,'''++'++;,.```` ``.;+#'####'`  .++####++++##################+######+#####+++'..``       `,;:.`  `:+++';.                   
                                 `;'++++',..```      `:++#+####`  `;++####+++#################+####@########++';,```       `...`    ,++++':`                  
                                 .'++++;.```    `  ````;+####+#;   ,+#####++'+#++###########################+++:...```     `````    `;+++'',``                
                                `:'++',.` ```` ` `   ``,+++#####`  .'######+''+++'+#+++++###################++':,.````       ``      `+++'''+'':``            
                                .;''':. ` ``.,,````````.'+'+####,  `;+#####++''''++##++++++++#############++++;,.```                  .++'''+++++':`          
                                .'++',  `.:'';'+'';`.```,++#+###'` `,+#####+++'''++''+'++++++++############+++,,.```                   ,;''+++++''':          
                                ,'++'`.,''''+++''+++;,``.'+#+####. `.'+##+++'';;'++'''''''++++++###########++':,```                      `,'+++++++:          
                               `;'+'':'''''+++++++++++,..:++#+###;``.;#+++''''';'''''''++'''+++#+#+######+#++:..``                         `.;'''':.          
                               `;+'';'+'+++#+'#+###+#+#'..'++++###, `;++'''''';;';'+++'+''''+++++++++#####+++:..```                       ```.,;;,`           
                               .'''';''+'++##++;#+##'###+.,++++###;,`'+'''+''';,;;'''+'''''''+++#'+;+##+#++';,.````                     `````...``            
                              `:'';'++'#+#++;''+####+####+:;+###+#++''++++''';+'';;;''';'''+''+++++'++'+#+;':.`.`.````                  `````````             
                            ``.;;''+++++##+,..,+##########+:+++##+'+++'++'';;+#+';;;''';'';'++'+++++#+#'+++;.`.:.,.````                  ```````              
                           .,;;;'++'+++++'```..:+#######+##;;+++++'++''+'''+++'+'';;;''''';;+''++++#'#+++;':,.;+++;:.`````                                    
                         `,;';'+++#'+++'+`    .`:+##'#+#####'''++''+++++''';'+++'''''''''+'''+'++'#+++++'';:####++'+++:.```                                   
                       `,;;''+++'##++;''`      `,,+#####+####;'''+++++++;'';''''':;''''';';'''+;+';;;'+'+;+######++++++',````                                 
                       ,;''+#+++++##+;.        ``.:++########'''++''+''';'+';;':;'';''''+'';;++':',:;:';;####+###+#++++++',```                                
                     `.;'+#+++'++'+,`.        ```.,:+######+#'+'++++#++'+#####++##''+++++'+''++;'++'+'+'#########+++'++++'+.`                                 
                    `.;'++';++++':..``         ````,:+#+####'+'''+++'''#+#####+##''+'+'#++#+++;'+'+'#';'#########'+##+++;++'.`                                
                    :''+'+++++':,.``````  ` ` ```,'++#++####+''+'++''+#+##+++#+''++++''+##++''''++++#';#'########';;#+++++++'.                                
                  `:''++'+''';,````        ```.;'''++####+#++++++''+++''+++'#+;'++++++++###+''++'+++#+#+#########+:;;#+++++++;``                              
                 `.'+'''''';,`              `,+'+'++####+##+;+'+''+++'++++++++';++++''+'##+#;'''+#++'+++########+;:.:'+#++'++':`                              
                ``''''++'+,`               .,++++#'+#+######'''+''++';+++++++#'++++++'''####+'+++++#+++#######+';:,.`.'+#+++++',`                             
                `'+++'+'',`                ;++++++++########+''''+''+''++++'++++++++++++#####+#+++++#+++'##++;;;:,`````++++#++++,``                           
              ``''++''::,                `''++++#+#;###@#####+'''++'+++#+#+#+'+'''+#+'+#######+++#++++''+';::,..```   `.+'+###+++:,`                          
              .''++''..`                `''+'++##+;;+##@#@###++''''+#+##++####++'++++++##+###+';+#+++'+++;,``````      ``;###++#++;.`                         
             `;'++++;`                  ;++'+++++;:;########'++#++++#+#######+##''+++++++##+###++#++++#++,.`` ` `         :'##+++#''.`                        
            .,+''++'`                  ,++;++++#;,'########'''++#+++####++##++'+'#####++######+'#++++++++:````            ..;++++###+,`                       
           `:'+;'++.`                 `++'++'+++,.,';#####+'+;+++++++##+##+#++##++###+#'+#####'+++#++++++,.```            `` ,+##+##'+.`                      
          `,'+''++;                  `'+''+++++, .``:;'+#+##+''++++++'#+##++#++''++##++#'+###++#+++++++++.```` `             `,'+#+#++':`                     
         ``;'+''''                 ``,''+++'++;`` ```.,.,;;++'+++'+##'#+###+#'''++#+#++'+####+#'#++++++++'.`````              `,'+#+++++;`                    
       ` `:''+++'`                 `,++++'+'++``   ```..,.,,'+'#+'''+'##+++++++'#+#+++''+###++#'++#++++++'.`` `                 ,'#++++++,`                   
       `.+'++'+'.                 `,+++#+#+'',   ````.`..,,,'++++';'''##+#+#'+'#++###+++###+#+';''#+++++++:``                    `'+++++++```                 
     ``:++++++;                  `,+++###++'.  `````````...:+++++';;;+++####++++++++#++''++#'';;::+++''+++'``                     .'++++#+,`                  
    `.'++++#+'                  .:+++#+++++.`````````````..;+'+++';;;+++######++'+++++++'''''';;::'+++++#+;:.                      .''+#+++,`                 
   `.+++++++;                  .,+++#+++++:```````````````.;'++++';;;'++#+++++#+++++++++';''';;::::;##++++':.```                    ,';+#+++``                
   ,+#++''':`               ``.:'++++++++.,```````````````.''++++;;;;;+##+#++#+++++'++++'';;;;:::,,;+++++++:..``                     `:;#++++``               
  ,'++++''.                 `.;'+++++++'.``    ``````````.,'++++'';;;'++++++##'++'++++++';;;;:::,,,;++#++#+',`````                    ``'++#'+,`              
 .+'++++'````````  `    `  ``;'+++++#''````         `````..;+'+''':;;;'+'++++''++'++++++';::::,,,,,;;+++++++:,`````                    `.;#++#+:``            
 ,'+++':````````           `:'++++++''``             `````:'++#'':::::;;''''''''''++++++'::::,,....,:'#++++++:``````                    `;+++##+:.`           
  :'';..````               ,'+++++++'`                ` `.,'++++;::,,,,,:;''''''';''+##+;:,,,...``...,#+##+++;.```````                   `'++##++,`           
   ```                    `''+++++''`                   ``;+++++:,,,.....:;'''';;;;+###+':,...``````..'#++++++:```````                    `''+##++:           
                         `;+'++++''.                   ```;+#+++'........,:;;;;:::;'++#++;.```````````,+++++++'.```````                   ``'+'+#+'.          
                        `.++++++++,                   ````'##+++;.`````....,,,,,..,'++#+++````````````,'#++#+++,````````                   `:'+++++:          
                      ``.:++#'+++:`                ```````++#+++,``````.........``.'+##+++`````````````:#++++++;```````                     `'+++++#,`        
                       `,''+++'+'                 ```````.++#+++``````.......``````'+#+#++.````````    .++++#++'````                         `'+++###,`       
                       `+++++':;`                ````````,++#+++`````.......```````:+#+#++;`````       `'+++++++,``                          ``,+##+##:``     
                       '+++'',,`                 ````````,++#+++``````..````````````+++#++:`````        ,'++++++:`                    `      ```'+##+##;`     
                     `;++++',.`                 ```````.`,'+#++;````````````````````+++#++'````         `'+++##+;`                      ` ``````.++#+###'     
                    `:+#++++`                   `````````,++#++.````````````````````++###+'````          .++###+'.`                       ```````.++####+;    
                   `,+##+++;                    `````````.+++++```````   ` `````````;+###+'````          `:+#++#',`                         `````.,++#+#++,   
                  `:'+#++''                     `````````.++++;`````          ```````+++++:````           `'+#+##,`                           ````.,'++#+++`  
                 `.;+#+++'`                            ```:++'```               `````++++#.```            `.;++##'.                            ````.:++#+++`  
                 `'++#++';                                `;;`                    ```.+++:.``              `.'####:`                             ````,'+#++`  
                 ,++#++''                                                           ``.+;``                 `'+###+:`                              ```,;''.`  
                 ;'++++'.                                                                                    :+###++.                                 ````    
                .'''+'''                                                                                     .++###+;`                                        
               .;##+'+'                                                                                      `'+####+,                                        
              `:##+++,                                                                                        ,++###+'`                                       
              ,++#+++`                                                                                        `'+###++:                                       
             ,++#+++'                                                                                          ;++###+'`                                      
            `'+#+++'`                                                                                          .++#++++`                                      
           `;###++':      `                                                                                     ;+++++'`                                      
           .++#+++'   ````                                                                                      `'+###+:`                                     
          `++#+++'``````                                                                                         `'###+'.`                                    
          .+++++'``````                                                                                          `++###+;`                                    
         `.'++++.````                                                                                     `      `'+###+'`                                    
         `:+++'.````                                                                                      ```` ` `'+###++.                                    
         ``'';.```                                                                                         ```````:+####+:`                                   
            ``                                                                                              ``````,+####+;`                                   
                                                                                                             ``````++###+'`                                   
                                                                                                              `````'+#+++'`                                   
                                                                                                               ````,+++++'`                                   
                                                                                                                ```.;++++:`                                   
                                                                                                                 ```.'+++:`                                   
                                                                                                                  ```.'+'.`                                   
                                                                                                                     ``.`                                     
                                                                                                                                            
																																			*/
require('dotenv').config(); // Load env vars if you use dotenv

const timeout = require('connect-timeout');
const express = require('express');
const app = express();

if (process.env.machine === "turnstile") {
  console.log('loading turnstile files');

  const Port_control = require('./pretix-app/serialport-terminal');

  // TODO: Replace this with your actual valid ticket types object
  const valid_ticket_types = {
    csvTickets: ['TICKET1', 'TICKET2', 'TICKET3']
  };

  const port_control = Port_control(valid_ticket_types);

  const Turnstile_control = require('./pretix-app/turnstile-controller');
  const turnstile_control = new Turnstile_control();

  (async () => {
    try {
      await new Promise((resolve, reject) => {
        turnstile_control.connect(null, (err) => {
          if (err) return reject(err);
          resolve();
        });
      });
      console.log("✅ Turnstile controller connected and ticket data loaded.");
   //   console.log('port_control:', port_control);

      port_control.listenData();  // now this should work without error
    } catch (error) {
      console.error("❌ Error connecting turnstile controller:", error);
    }
  })();

  app.use(timeout('60s'));
}

// ...rest of your express app code

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

module.exports = app;



